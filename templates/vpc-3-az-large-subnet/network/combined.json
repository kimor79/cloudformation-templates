{"AWSTemplateFormatVersion": "2010-09-09", "Parameters": {"CorpSubnet1": {"AllowedPattern": "^(?:(?:[1-9]?[0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\\.){3}(?:[1-9]?[0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])/(?:[12]?[0-9]|3[0-2])$", "Default": "192.168.10.0/24", "Type": "String", "Description": "The subnet of the corporate LAN", "ConstraintDescription": "must be in CIDR notation (e.g., 192.168.0.0/24)"}, "VPCSupernetPrefix": {"AllowedPattern": "^(?:[1-9]?[0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\\.(?:[1-9]?[0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])$", "Default": "10.11", "Type": "String", "Description": "First 2 octets of the VPC CIDR supernet", "ConstraintDescription": "must only contain the first 2 octets"}, "VPCName": {"Default": "VPC", "MinLength": 1, "Type": "String", "Description": "The name of this VPC"}, "EnableDnsHostnames": {"Default": false, "Type": "String", "Description": "Specifies whether the instances launched in the VPC get DNS hostnames", "AllowedValues": [false, true]}, "AvailabilityZones": {"Default": "a,b,c", "Type": "CommaDelimitedList", "Description": "The availability zones this VPC should span. Only the first 3 will be used"}}, "Resources": {"AssociateEIPENINATAZ3": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "ENINATAZ3"}, "AllocationId": {"Fn::GetAtt": ["EIPNATAZ3", "AllocationId"]}}}, "AssociateEIPENINATAZ2": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "ENINATAZ2"}, "AllocationId": {"Fn::GetAtt": ["EIPNATAZ2", "AllocationId"]}}}, "AssociateEIPENINATAZ1": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "ENINATAZ1"}, "AllocationId": {"Fn::GetAtt": ["EIPNATAZ1", "AllocationId"]}}}, "RouteTableNATAZ1": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT AZ ", {"Fn::Select": [0, {"Ref": "AvailabilityZones"}]}, " (", {"Ref": "VPCName"}, ")"]]}}]}}, "RouteNATAZ1": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "ENINATAZ1"}, "RouteTableId": {"Ref": "RouteTableNATAZ1"}}}, "RouteTableNATAZ3": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT AZ ", {"Fn::Select": [2, {"Ref": "AvailabilityZones"}]}, " (", {"Ref": "VPCName"}, ")"]]}}]}}, "RouteNATAZ3": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "ENINATAZ3"}, "RouteTableId": {"Ref": "RouteTableNATAZ3"}}}, "SGAllowAllFromVPCIngressAllow": {"Type": "AWS::EC2::SecurityGroupIngress", "Properties": {"SourceSecurityGroupId": {"Ref": "SGAllowAllFromVPC"}, "FromPort": -1, "ToPort": -1, "GroupId": {"Ref": "SGAllowAllFromVPC"}, "IpProtocol": -1}}, "EIPNATAZ3": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}, "DependsOn": "VPC"}, "EIPNATAZ2": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}, "DependsOn": "VPC"}, "EIPNATAZ1": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}, "DependsOn": "VPC"}, "InternetGateway": {"Type": "AWS::EC2::InternetGateway", "Properties": {"Tags": [{"Value": {"Ref": "VPCName"}, "Key": "Name"}]}}, "SubnetPrivateAZ3": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Private AZ ", {"Fn::Select": [2, {"Ref": "AvailabilityZones"}]}, ", uses NAT (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "128.0/20"]]}, "AvailabilityZone": {"Fn::Join": ["", [{"Ref": "AWS::Region"}, {"Fn::Select": [2, {"Ref": "AvailabilityZones"}]}]]}}}, "RouteNATAZ2": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "ENINATAZ2"}, "RouteTableId": {"Ref": "RouteTableNATAZ2"}}}, "RouteTableInternetGateway": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Value": {"Fn::Join": ["", ["Direct Internet (", {"Ref": "VPCName"}, ")"]]}, "Key": "Name"}]}}, "SubnetPublicAZ1": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Public AZ ", {"Fn::Select": [0, {"Ref": "AvailabilityZones"}]}, ", requires EIP (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "16.0/21"]]}, "AvailabilityZone": {"Fn::Join": ["", [{"Ref": "AWS::Region"}, {"Fn::Select": [0, {"Ref": "AvailabilityZones"}]}]]}}}, "AssociateSubnetPublicAZ2RouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZ2"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "DBSubnetPublic": {"Type": "AWS::RDS::DBSubnetGroup", "Properties": {"SubnetIds": [{"Ref": "SubnetPublicAZ1"}, {"Ref": "SubnetPublicAZ2"}, {"Ref": "SubnetPublicAZ3"}], "DBSubnetGroupDescription": {"Fn::Join": ["", ["Public (", {"Ref": "VPCName"}, ")"]]}}}, "SubnetPrivateAZ1": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Private AZ ", {"Fn::Select": [0, {"Ref": "AvailabilityZones"}]}, ", uses NAT (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "0.0/20"]]}, "AvailabilityZone": {"Fn::Join": ["", [{"Ref": "AWS::Region"}, {"Fn::Select": [0, {"Ref": "AvailabilityZones"}]}]]}}}, "AssociateSubnetPublicAZ1RouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZ1"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "RouteTableNATAZ2": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT AZ ", {"Fn::Select": [1, {"Ref": "AvailabilityZones"}]}, " (", {"Ref": "VPCName"}, ")"]]}}]}}, "VPC": {"Type": "AWS::EC2::VPC", "Properties": {"CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "0.0/16"]]}, "EnableDnsHostnames": {"Ref": "EnableDnsHostnames"}, "Tags": [{"Value": {"Ref": "VPCName"}, "Key": "Name"}]}}, "RouteInternetGateway": {"Type": "AWS::EC2::Route", "Properties": {"GatewayId": {"Ref": "InternetGateway"}, "DestinationCidrBlock": "0.0.0.0/0", "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "SGAllowAllFromVPC": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow all from within the VPC", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Within VPC (", {"Ref": "VPCName"}, ")"]]}}]}}, "SGAllowAllFromCorp": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"SecurityGroupIngress": [{"ToPort": -1, "FromPort": -1, "CidrIp": {"Ref": "CorpSubnet1"}, "IpProtocol": -1}], "VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow all from Corp", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Corp (", {"Ref": "VPCName"}, ")"]]}}]}}, "ENINATAZ3": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZ3"}, "SourceDestCheck": false, "GroupSet": [{"Ref": "SGAllowAllFromVPC"}, {"Ref": "SGAllowAllFromCorp"}], "Description": {"Fn::Join": [" ", ["NAT AZ", {"Fn::Select": [2, {"Ref": "AvailabilityZones"}]}]]}, "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT-", {"Fn::Select": [2, {"Ref": "AvailabilityZones"}]}, " (", {"Ref": "VPCName"}, ")"]]}}]}}, "ENINATAZ2": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZ2"}, "SourceDestCheck": false, "GroupSet": [{"Ref": "SGAllowAllFromVPC"}, {"Ref": "SGAllowAllFromCorp"}], "Description": {"Fn::Join": [" ", ["NAT AZ", {"Fn::Select": [1, {"Ref": "AvailabilityZones"}]}]]}, "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT-", {"Fn::Select": [1, {"Ref": "AvailabilityZones"}]}, " (", {"Ref": "VPCName"}, ")"]]}}]}}, "ENINATAZ1": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZ1"}, "SourceDestCheck": false, "GroupSet": [{"Ref": "SGAllowAllFromVPC"}, {"Ref": "SGAllowAllFromCorp"}], "Description": {"Fn::Join": [" ", ["NAT AZ", {"Fn::Select": [0, {"Ref": "AvailabilityZones"}]}]]}, "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT-", {"Fn::Select": [0, {"Ref": "AvailabilityZones"}]}, " (", {"Ref": "VPCName"}, ")"]]}}]}}, "RedshiftSubnetPrivate": {"Type": "AWS::Redshift::ClusterSubnetGroup", "Properties": {"SubnetIds": [{"Ref": "SubnetPrivateAZ1"}, {"Ref": "SubnetPrivateAZ2"}, {"Ref": "SubnetPrivateAZ3"}], "Description": {"Fn::Join": ["", ["Private (", {"Ref": "VPCName"}, ")"]]}}}, "AssociateSubnetPrivateAZ3RouteTableNATAZ3": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateAZ3"}, "RouteTableId": {"Ref": "RouteTableNATAZ3"}}}, "SubnetPublicAZ2": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Public AZ ", {"Fn::Select": [1, {"Ref": "AvailabilityZones"}]}, ", requires EIP (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "80.0/21"]]}, "AvailabilityZone": {"Fn::Join": ["", [{"Ref": "AWS::Region"}, {"Fn::Select": [1, {"Ref": "AvailabilityZones"}]}]]}}}, "AttachInternetGateway": {"Type": "AWS::EC2::VPCGatewayAttachment", "Properties": {"VpcId": {"Ref": "VPC"}, "InternetGatewayId": {"Ref": "InternetGateway"}}}, "AssociateSubnetPrivateAZ1RouteTableNATAZ1": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateAZ1"}, "RouteTableId": {"Ref": "RouteTableNATAZ1"}}}, "SubnetPrivateAZ2": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Private AZ ", {"Fn::Select": [1, {"Ref": "AvailabilityZones"}]}, ", uses NAT (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "64.0/20"]]}, "AvailabilityZone": {"Fn::Join": ["", [{"Ref": "AWS::Region"}, {"Fn::Select": [1, {"Ref": "AvailabilityZones"}]}]]}}}, "SGAllowHTTPFromEverywhere": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"SecurityGroupIngress": [{"ToPort": 80, "FromPort": 80, "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp"}, {"ToPort": 443, "FromPort": 443, "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp"}], "VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow HTTP from everywhere", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["HTTP (", {"Ref": "VPCName"}, ")"]]}}]}}, "DBSubnetPrivate": {"Type": "AWS::RDS::DBSubnetGroup", "Properties": {"SubnetIds": [{"Ref": "SubnetPrivateAZ1"}, {"Ref": "SubnetPrivateAZ2"}, {"Ref": "SubnetPrivateAZ3"}], "DBSubnetGroupDescription": {"Fn::Join": ["", ["Private (", {"Ref": "VPCName"}, ")"]]}}}, "AssociateSubnetPrivateAZ2RouteTableNATAZ2": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateAZ2"}, "RouteTableId": {"Ref": "RouteTableNATAZ2"}}}, "AssociateSubnetPublicAZ3RouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZ3"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "EndpointS3": {"Type": "AWS::EC2::VPCEndpoint", "Properties": {"VpcId": {"Ref": "VPC"}, "RouteTableIds": [{"Ref": "RouteTableNATAZ1"}, {"Ref": "RouteTableNATAZ2"}, {"Ref": "RouteTableNATAZ3"}, {"Ref": "RouteTableInternetGateway"}], "ServiceName": {"Fn::Join": ["", ["com.amazonaws.", {"Ref": "AWS::Region"}, ".s3"]]}}}, "SubnetPublicAZ3": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Public AZ ", {"Fn::Select": [2, {"Ref": "AvailabilityZones"}]}, ", requires EIP (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "144.0/21"]]}, "AvailabilityZone": {"Fn::Join": ["", [{"Ref": "AWS::Region"}, {"Fn::Select": [2, {"Ref": "AvailabilityZones"}]}]]}}}, "RedshiftSubnetPublic": {"Type": "AWS::Redshift::ClusterSubnetGroup", "Properties": {"SubnetIds": [{"Ref": "SubnetPublicAZ1"}, {"Ref": "SubnetPublicAZ2"}, {"Ref": "SubnetPublicAZ3"}], "Description": {"Fn::Join": ["", ["Public (", {"Ref": "VPCName"}, ")"]]}}}}, "Description": "VPC spanning 3 AZs with large subnets"}