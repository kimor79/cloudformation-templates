{"AWSTemplateFormatVersion": "2010-09-09", "Parameters": {"VPCSupernetPrefix": {"AllowedPattern": "[0-9]+\\.[0-9]+", "Default": 10.11, "Type": "String", "Description": "First 2 octets of the VPC CIDR supernet", "ConstraintDescription": "must only contain the first 2 octets"}, "VPCName": {"Default": "VPC", "MinLength": 1, "Type": "String", "Description": "The name of this VPC"}}, "Resources": {"SGAllowAllFromVPCIngressAllow": {"Type": "AWS::EC2::SecurityGroupIngress", "Properties": {"SourceSecurityGroupId": {"Ref": "SGAllowAllFromVPC"}, "FromPort": -1, "ToPort": -1, "GroupId": {"Ref": "SGAllowAllFromVPC"}, "IpProtocol": -1}}, "AssociateSubnetPrivateELBAZBRouteTableNATAZB": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateELBAZB"}, "RouteTableId": {"Ref": "RouteTableNATAZB"}}}, "AssociateSubnetPublicELBAZBRouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPublicELBAZB"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "AssociateSubnetNATAZARouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetNATAZA"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "AssociateSubnetPrivateDevAZARouteTableNATAZA": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateDevAZA"}, "RouteTableId": {"Ref": "RouteTableNATAZA"}}}, "SubnetPrivateDevAZC": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Dev (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "72.0/24"]]}, "AvailabilityZone": "us-west-2c"}}, "SubnetPrivateDevAZB": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Dev (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "71.0/24"]]}, "AvailabilityZone": "us-west-2b"}}, "SubnetPrivateDevAZA": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Dev (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "70.0/24"]]}, "AvailabilityZone": "us-west-2a"}}, "AssociateSubnetPublicELBAZCRouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPublicELBAZC"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "InternetGateway": {"Type": "AWS::EC2::InternetGateway", "Properties": {"Tags": [{"Value": {"Ref": "VPCName"}, "Key": "Name"}]}}, "RouteTableInternetGateway": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Value": {"Fn::Join": ["", ["Direct Internet (", {"Ref": "VPCName"}, ")"]]}, "Key": "Name"}]}}, "RouteNATAZA": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "ENINATAZA"}, "RouteTableId": {"Ref": "RouteTableNATAZA"}}}, "AssociateSubnetPrivateInfraAZCRouteTableNATAZC": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateInfraAZC"}, "RouteTableId": {"Ref": "RouteTableNATAZC"}}}, "SubnetPublicELBAZA": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Public ELBs (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "10.0/24"]]}, "AvailabilityZone": "us-west-2a"}}, "SubnetPublicELBAZB": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Public ELBs (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "11.0/24"]]}, "AvailabilityZone": "us-west-2b"}}, "SubnetPublicELBAZC": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Public ELBs (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "12.0/24"]]}, "AvailabilityZone": "us-west-2c"}}, "VPC": {"Type": "AWS::EC2::VPC", "Properties": {"CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "0.0/16"]]}, "Tags": [{"Value": {"Ref": "VPCName"}, "Key": "Name"}]}}, "ENINATAZC": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetNATAZC"}, "SourceDestCheck": false, "GroupSet": [{"Ref": "SGAllowAllFromVPC"}, {"Ref": "SGAllowAllFromCorp"}], "Description": "NAT AZ C", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT-C (", {"Ref": "VPCName"}, ")"]]}}]}}, "ENINATAZB": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetNATAZB"}, "SourceDestCheck": false, "GroupSet": [{"Ref": "SGAllowAllFromVPC"}, {"Ref": "SGAllowAllFromCorp"}], "Description": "NAT AZ B", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT-B (", {"Ref": "VPCName"}, ")"]]}}]}}, "ENINATAZA": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetNATAZA"}, "SourceDestCheck": false, "GroupSet": [{"Ref": "SGAllowAllFromVPC"}, {"Ref": "SGAllowAllFromCorp"}], "Description": "NAT AZ A", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT-A (", {"Ref": "VPCName"}, ")"]]}}]}}, "SubnetPrivateInfraAZA": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Infrastructure (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "30.0/24"]]}, "AvailabilityZone": "us-west-2a"}}, "SGAllow8022FromEverywhere": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"SecurityGroupIngress": [{"ToPort": 8022, "FromPort": 8022, "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp"}], "VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow SSH (over 8022) from everywhere", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["SSH (", {"Ref": "VPCName"}, ")"]]}}]}}, "SubnetPrivateInfraAZC": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Infrastructure (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "32.0/24"]]}, "AvailabilityZone": "us-west-2c"}}, "SGAllowAllFromVPC": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow all from within the VPC", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Within VPC (", {"Ref": "VPCName"}, ")"]]}}]}}, "SGAllowAllFromCorp": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"SecurityGroupIngress": [{"ToPort": -1, "FromPort": -1, "CidrIp": "192.168.10.0/24", "IpProtocol": -1}], "VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow all from Corp", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Corp (", {"Ref": "VPCName"}, ")"]]}}]}}, "RouteTableNATAZC": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Value": {"Fn::Join": ["", ["NAT AZ C (", {"Ref": "VPCName"}, ")"]]}, "Key": "Name"}]}}, "EIPNATAZB": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}, "DependsOn": "VPC"}, "AssociateSubnetPublicELBAZARouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPublicELBAZA"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "AssociateSubnetPrivateELBAZCRouteTableNATAZC": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateELBAZC"}, "RouteTableId": {"Ref": "RouteTableNATAZC"}}}, "SubnetPrivateELBAZA": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Private ELBs (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "15.0/24"]]}, "AvailabilityZone": "us-west-2a"}}, "SubnetPrivateELBAZC": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Private ELBs (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "17.0/24"]]}, "AvailabilityZone": "us-west-2c"}}, "SubnetPrivateELBAZB": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Private ELBs (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "16.0/24"]]}, "AvailabilityZone": "us-west-2b"}}, "AssociateSubnetNATAZCRouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetNATAZC"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "SubnetNATAZC": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT/Proxies/Tunnels/etc (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "2.0/24"]]}, "AvailabilityZone": "us-west-2c"}}, "SubnetNATAZB": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT/Proxies/Tunnels/etc (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "1.0/24"]]}, "AvailabilityZone": "us-west-2b"}}, "SubnetNATAZA": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT/Proxies/Tunnels/etc (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "0.0/24"]]}, "AvailabilityZone": "us-west-2a"}}, "RouteNATAZC": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "ENINATAZC"}, "RouteTableId": {"Ref": "RouteTableNATAZC"}}}, "RouteInternetGateway": {"Type": "AWS::EC2::Route", "Properties": {"GatewayId": {"Ref": "InternetGateway"}, "DestinationCidrBlock": "0.0.0.0/0", "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "SGAllowHTTPFromEverywhere": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"SecurityGroupIngress": [{"ToPort": 80, "FromPort": 80, "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp"}, {"ToPort": 443, "FromPort": 443, "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp"}], "VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow HTTP from everywhere", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["HTTP (", {"Ref": "VPCName"}, ")"]]}}]}}, "EIPNATAZC": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}, "DependsOn": "VPC"}, "AssociateSubnetPrivateELBAZARouteTableNATAZA": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateELBAZA"}, "RouteTableId": {"Ref": "RouteTableNATAZA"}}}, "EIPNATAZA": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}, "DependsOn": "VPC"}, "AssociateSubnetPrivateDevAZCRouteTableNATAZC": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateDevAZC"}, "RouteTableId": {"Ref": "RouteTableNATAZC"}}}, "AssociateSubnetPrivateDevAZBRouteTableNATAZB": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateDevAZB"}, "RouteTableId": {"Ref": "RouteTableNATAZB"}}}, "AssociateEIPENINATAZC": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "ENINATAZC"}, "AllocationId": {"Fn::GetAtt": ["EIPNATAZC", "AllocationId"]}}}, "AssociateEIPENINATAZB": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "ENINATAZB"}, "AllocationId": {"Fn::GetAtt": ["EIPNATAZB", "AllocationId"]}}}, "AssociateEIPENINATAZA": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "ENINATAZA"}, "AllocationId": {"Fn::GetAtt": ["EIPNATAZA", "AllocationId"]}}}, "AttachInternetGateway": {"Type": "AWS::EC2::VPCGatewayAttachment", "Properties": {"VpcId": {"Ref": "VPC"}, "InternetGatewayId": {"Ref": "InternetGateway"}}}, "RouteTableNATAZA": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Value": {"Fn::Join": ["", ["NAT AZ A (", {"Ref": "VPCName"}, ")"]]}, "Key": "Name"}]}}, "SubnetPrivateInfraAZB": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Infrastructure (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "31.0/24"]]}, "AvailabilityZone": "us-west-2b"}}, "RouteNATAZB": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "ENINATAZB"}, "RouteTableId": {"Ref": "RouteTableNATAZB"}}}, "RouteTableNATAZB": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Value": {"Fn::Join": ["", ["NAT AZ B (", {"Ref": "VPCName"}, ")"]]}, "Key": "Name"}]}}, "AssociateSubnetPrivateInfraAZARouteTableNATAZA": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateInfraAZA"}, "RouteTableId": {"Ref": "RouteTableNATAZA"}}}, "AssociateSubnetPrivateInfraAZBRouteTableNATAZB": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateInfraAZB"}, "RouteTableId": {"Ref": "RouteTableNATAZB"}}}, "AssociateSubnetNATAZBRouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetNATAZB"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}}, "Description": "VPC us-west-2"}