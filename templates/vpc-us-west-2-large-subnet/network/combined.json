{"AWSTemplateFormatVersion": "2010-09-09", "Parameters": {"VPCSupernetPrefix": {"AllowedPattern": "^(?:[1-9]?[0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\\.(?:[1-9]?[0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])$", "Default": "10.11", "Type": "String", "Description": "First 2 octets of the VPC CIDR supernet", "ConstraintDescription": "must only contain the first 2 octets"}, "VPCName": {"Default": "VPC", "MinLength": 1, "Type": "String", "Description": "The name of this VPC"}, "EnableDnsHostnames": {"Default": false, "Type": "String", "Description": "Specifies whether the instances launched in the VPC get DNS hostnames", "AllowedValues": [false, true]}, "CorpSubnet1": {"AllowedPattern": "^(?:(?:[1-9]?[0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\\.){3}(?:[1-9]?[0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])/(?:[12]?[0-9]|3[0-2])$", "Default": "192.168.10.0/24", "Type": "String", "Description": "The subnet of the corporate LAN", "ConstraintDescription": "must be in CIDR notation (e.g., 192.168.0.0/24)"}}, "Resources": {"SGAllowAllFromVPCIngressAllow": {"Type": "AWS::EC2::SecurityGroupIngress", "Properties": {"SourceSecurityGroupId": {"Ref": "SGAllowAllFromVPC"}, "FromPort": -1, "ToPort": -1, "GroupId": {"Ref": "SGAllowAllFromVPC"}, "IpProtocol": -1}}, "AssociateSubnetPublicAZARouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZA"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "AssociateSubnetPublicAZBRouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZB"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "SubnetPublicAZC": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Public AZ C, requires EIP (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "144.0/21"]]}, "AvailabilityZone": "us-west-2c"}}, "InternetGateway": {"Type": "AWS::EC2::InternetGateway", "Properties": {"Tags": [{"Value": {"Ref": "VPCName"}, "Key": "Name"}]}}, "AssociateSubnetPublicAZCRouteTableInternetGateway": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZC"}, "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "AssociateSubnetPrivateAZARouteTableNATAZA": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateAZA"}, "RouteTableId": {"Ref": "RouteTableNATAZA"}}}, "RouteTableInternetGateway": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Value": {"Fn::Join": ["", ["Direct Internet (", {"Ref": "VPCName"}, ")"]]}, "Key": "Name"}]}}, "RouteNATAZA": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "ENINATAZA"}, "RouteTableId": {"Ref": "RouteTableNATAZA"}}}, "DBSubnetPublic": {"Type": "AWS::RDS::DBSubnetGroup", "Properties": {"SubnetIds": [{"Ref": "SubnetPublicAZA"}, {"Ref": "SubnetPublicAZB"}, {"Ref": "SubnetPublicAZC"}], "DBSubnetGroupDescription": {"Fn::Join": ["", ["Public (", {"Ref": "VPCName"}, ")"]]}}}, "DBSubnetPrivate": {"Type": "AWS::RDS::DBSubnetGroup", "Properties": {"SubnetIds": [{"Ref": "SubnetPrivateAZA"}, {"Ref": "SubnetPrivateAZB"}, {"Ref": "SubnetPrivateAZC"}], "DBSubnetGroupDescription": {"Fn::Join": ["", ["Private (", {"Ref": "VPCName"}, ")"]]}}}, "VPC": {"Type": "AWS::EC2::VPC", "Properties": {"CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "0.0/16"]]}, "EnableDnsHostnames": {"Ref": "EnableDnsHostnames"}, "Tags": [{"Value": {"Ref": "VPCName"}, "Key": "Name"}]}}, "ENINATAZC": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZC"}, "SourceDestCheck": false, "GroupSet": [{"Ref": "SGAllowAllFromVPC"}, {"Ref": "SGAllowAllFromCorp"}], "Description": "NAT AZ C", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT-C (", {"Ref": "VPCName"}, ")"]]}}]}}, "ENINATAZB": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZB"}, "SourceDestCheck": false, "GroupSet": [{"Ref": "SGAllowAllFromVPC"}, {"Ref": "SGAllowAllFromCorp"}], "Description": "NAT AZ B", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT-B (", {"Ref": "VPCName"}, ")"]]}}]}}, "ENINATAZA": {"Type": "AWS::EC2::NetworkInterface", "Properties": {"SubnetId": {"Ref": "SubnetPublicAZA"}, "SourceDestCheck": false, "GroupSet": [{"Ref": "SGAllowAllFromVPC"}, {"Ref": "SGAllowAllFromCorp"}], "Description": "NAT AZ A", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT-A (", {"Ref": "VPCName"}, ")"]]}}]}}, "RouteNATAZB": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "ENINATAZB"}, "RouteTableId": {"Ref": "RouteTableNATAZB"}}}, "SubnetPublicAZA": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Public AZ A, requires EIP (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "16.0/21"]]}, "AvailabilityZone": "us-west-2a"}}, "SGAllowAllFromVPC": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow all from within the VPC", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Within VPC (", {"Ref": "VPCName"}, ")"]]}}]}}, "SGAllowAllFromCorp": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"SecurityGroupIngress": [{"ToPort": -1, "FromPort": -1, "CidrIp": {"Ref": "CorpSubnet1"}, "IpProtocol": -1}], "VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow all from Corp", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Corp (", {"Ref": "VPCName"}, ")"]]}}]}}, "SubnetPrivateAZA": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Private AZ A, uses NAT (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "0.0/20"]]}, "AvailabilityZone": "us-west-2a"}}, "RouteNATAZC": {"Type": "AWS::EC2::Route", "Properties": {"DestinationCidrBlock": "0.0.0.0/0", "NetworkInterfaceId": {"Ref": "ENINATAZC"}, "RouteTableId": {"Ref": "RouteTableNATAZC"}}}, "SubnetPublicAZB": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Public AZ B, requires EIP (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "80.0/21"]]}, "AvailabilityZone": "us-west-2b"}}, "AttachInternetGateway": {"Type": "AWS::EC2::VPCGatewayAttachment", "Properties": {"VpcId": {"Ref": "VPC"}, "InternetGatewayId": {"Ref": "InternetGateway"}}}, "RouteInternetGateway": {"Type": "AWS::EC2::Route", "Properties": {"GatewayId": {"Ref": "InternetGateway"}, "DestinationCidrBlock": "0.0.0.0/0", "RouteTableId": {"Ref": "RouteTableInternetGateway"}}}, "SGAllowHTTPFromEverywhere": {"Type": "AWS::EC2::SecurityGroup", "Properties": {"SecurityGroupIngress": [{"ToPort": 80, "FromPort": 80, "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp"}, {"ToPort": 443, "FromPort": 443, "CidrIp": "0.0.0.0/0", "IpProtocol": "tcp"}], "VpcId": {"Ref": "VPC"}, "GroupDescription": "Allow HTTP from everywhere", "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["HTTP (", {"Ref": "VPCName"}, ")"]]}}]}}, "AssociateSubnetPrivateAZBRouteTableNATAZB": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateAZB"}, "RouteTableId": {"Ref": "RouteTableNATAZB"}}}, "EIPNATAZC": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}, "DependsOn": "VPC"}, "EIPNATAZB": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}, "DependsOn": "VPC"}, "EIPNATAZA": {"Type": "AWS::EC2::EIP", "Properties": {"Domain": "vpc"}, "DependsOn": "VPC"}, "RouteTableNATAZA": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT AZ A (", {"Ref": "VPCName"}, ")"]]}}]}}, "AssociateSubnetPrivateAZCRouteTableNATAZC": {"Type": "AWS::EC2::SubnetRouteTableAssociation", "Properties": {"SubnetId": {"Ref": "SubnetPrivateAZC"}, "RouteTableId": {"Ref": "RouteTableNATAZC"}}}, "AssociateEIPENINATAZC": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "ENINATAZC"}, "AllocationId": {"Fn::GetAtt": ["EIPNATAZC", "AllocationId"]}}}, "AssociateEIPENINATAZB": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "ENINATAZB"}, "AllocationId": {"Fn::GetAtt": ["EIPNATAZB", "AllocationId"]}}}, "AssociateEIPENINATAZA": {"Type": "AWS::EC2::EIPAssociation", "Properties": {"NetworkInterfaceId": {"Ref": "ENINATAZA"}, "AllocationId": {"Fn::GetAtt": ["EIPNATAZA", "AllocationId"]}}}, "SubnetPrivateAZC": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Private AZ C, uses NAT (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "128.0/20"]]}, "AvailabilityZone": "us-west-2c"}}, "SubnetPrivateAZB": {"Type": "AWS::EC2::Subnet", "Properties": {"Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["Private AZ B, uses NAT (", {"Ref": "VPCName"}, ")"]]}}], "VpcId": {"Ref": "VPC"}, "CidrBlock": {"Fn::Join": [".", [{"Ref": "VPCSupernetPrefix"}, "64.0/20"]]}, "AvailabilityZone": "us-west-2b"}}, "RouteTableNATAZC": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT AZ C (", {"Ref": "VPCName"}, ")"]]}}]}}, "RouteTableNATAZB": {"Type": "AWS::EC2::RouteTable", "Properties": {"VpcId": {"Ref": "VPC"}, "Tags": [{"Key": "Name", "Value": {"Fn::Join": ["", ["NAT AZ B (", {"Ref": "VPCName"}, ")"]]}}]}}}, "Description": "VPC us-west-2"}